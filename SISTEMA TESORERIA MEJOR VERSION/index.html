<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA PRESUPUESTARIO DE TESORERIA - Municipio Torbes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           ESTILOS DEL SISTEMA (MODERNIZADOS)
           ========================================= */
        :root {
            --sys-primary: #0f172a; /* Azul oscuro corporativo */
            --sys-accent: #2563eb;  /* Azul brillante para acciones */
            --sys-border: #e2e8f0;  /* Gris suave para bordes */
            --sys-bg: #f8fafc;      /* Fondo muy claro */
            --sys-text: #334155;    /* Texto gris oscuro */
        }

        .system-wrapper { 
            font-family: 'Inter', sans-serif; 
            font-size: 11px; 
            width: 100%; 
            color: var(--sys-text);
        }
        
        .container-system { 
            max-width: 98%; 
            margin: 0 auto; 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.025); 
            border: 1px solid var(--sys-border);
        }
        
        /* Header del Reporte */
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--sys-primary); 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
        }
        .img-logo { height: 80px; width: auto; object-fit: contain; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }
        .official-header-container { text-align: center; flex: 1; }
        .official-header-text { font-weight: 600; color: #1e293b; line-height: 1.4; font-size: 11px; letter-spacing: 0.5px; }
        .system-title-blue { color: var(--sys-accent); font-weight: 800; font-size: 16px; text-transform: uppercase; margin-top: 12px; letter-spacing: 1px; }
        
        /* Controles (Botones) */
        .header-controls { margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; padding: 10px; background: #f1f5f9; border-radius: 8px; border: 1px solid var(--sys-border); }
        .btn-action { 
            padding: 8px 14px; 
            border: 1px solid transparent; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 11px; 
            font-weight: 600; 
            transition: all 0.2s ease; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-action:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .btn-action:active { transform: translateY(0); }
        
        /* Scroll y Tabla */
        .scroll-container { 
            overflow-x: auto; 
            max-height: 65vh; 
            border: 1px solid var(--sys-border); 
            border-radius: 8px;
            background: #fff; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
        }
        .content-min-width { min-width: 1900px; display: flex; flex-direction: column; }
        
        /* Grid de Info */
        .info-grid { display: grid; grid-template-columns: 63.2% 36.8%; width: 100%; border-bottom: 1px solid var(--sys-border); }
        .header-info-block { 
            text-align: left; font-size: 11px; padding: 12px; 
            color: #475569; line-height: 1.5; 
        }
        .financing-title { 
            font-size: 12px; font-weight: 700; 
            color: #fff; background-color: #64748b; 
            display: flex; align-items: center; justify-content: center; 
            letter-spacing: 0.5px;
        }
        
        /* Estilos de Tabla Sofisticados */
        table.system-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        table.system-table th { 
            background-color: var(--sys-primary) !important; 
            color: white !important; 
            padding: 10px 4px; 
            text-align: center; 
            font-size: 9.5px; 
            font-weight: 600; 
            letter-spacing: 0.3px;
            border-right: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 10; 
        }
        
        table.system-table td { 
            border: 1px solid var(--sys-border); 
            padding: 6px 4px; 
            text-align: center; 
            font-size: 10px; 
            color: #334155;
            word-wrap: break-word; overflow: hidden; 
            transition: background 0.1s;
        }
        
        table.system-table tr:nth-child(even) { background-color: #f8fafc; }
        table.system-table tr:hover td { background-color: #f1f5f9; }
        
        table.system-table td[contenteditable="true"]:focus { 
            background: #fff; 
            outline: 2px solid var(--sys-accent); 
            border-radius: 2px;
            z-index: 5; 
            color: black;
            font-weight: 500;
        }
        
        /* Tarjetas de Resumen */
        .summaries-wrapper { display: flex; gap: 20px; margin-top: 25px; align-items: flex-start; }
        .summary-card { 
            padding: 20px; 
            background: white; 
            border-radius: 8px; 
            border: 1px solid var(--sys-border); 
            border-top: 4px solid var(--sys-accent); 
            flex: 1; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .summary-card.financing { border-top-color: #10b981; }
        
        .summary-card strong { 
            display: block; margin-bottom: 12px; font-size: 12px; 
            text-transform: uppercase; color: #64748b; letter-spacing: 0.5px;
            border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; 
        }
        .summary-item { 
            display: flex; justify-content: space-between; padding: 6px 0; 
            border-bottom: 1px dashed #e2e8f0; font-size: 11px; 
        }
        .summary-item:last-child { border-bottom: none; }
        
        /* Botón Imprimir */
        .btn-print { 
            background: var(--sys-primary); color: white; 
            padding: 14px 30px; border: none; border-radius: 8px; 
            font-weight: 600; cursor: pointer; margin-top: 20px; 
            font-size: 13px; display: block; width: 100%;
            transition: background 0.2s; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.2);
        }
        .btn-print:hover { background: #1e293b; }
        
        #saveStatus { 
            position: fixed; bottom: 20px; right: 20px; 
            background: rgba(15, 23, 42, 0.9); color: #fff; 
            padding: 8px 16px; border-radius: 50px; 
            font-size: 12px; opacity: 0; transition: opacity 0.5s; 
            pointer-events: none; z-index: 9999; 
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* ESTILOS DE LA INTERFAZ DE LOGIN (Originales) */
        .oculto { display: none !important; }
        #contenedor-auth {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .card {
            background: white; padding: 2.5rem; border-radius: 1rem;
            width: 100%; max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            animation: subir 0.4s ease-out;
        }
        @keyframes subir {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .input-box {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1;
            border-radius: 8px; outline: none; font-size: 14px;
        }
        .input-box:focus { border-color: #2563eb; ring: 2px solid #2563eb; }

        /* Ajustes para Impresión */
        @media print {
            @page { size: landscape; margin: 0.4cm; }
            body { background: white; padding: 0; margin: 0; }
            #contenedor-auth, .fixed.top-0, .header-controls, .btn-print, #saveStatus { display: none !important; }
            div[style="height: 80px;"] { display: none; }
            
            .container-system { 
                padding: 0; border: none; box-shadow: none; width: 100%; margin: 0; 
                max-width: 100%;
            }
            .scroll-container { overflow: visible !important; max-height: none !important; border: none !important; box-shadow: none; }
            .content-min-width { min-width: 100% !important; width: 100% !important; }
            
            /* Volver a bordes simples para impresión clara */
            table.system-table th, table.system-table td { 
                font-size: 7px !important; 
                padding: 2px !important; 
                border: 0.5pt solid black !important; 
                color: black !important;
            }
            table.system-table th { background-color: #ccc !important; -webkit-print-color-adjust: exact; }
            
            .official-header-text { font-size: 9px !important; }
            .header-info-block { border: 1px solid black; }
            .financing-title { background-color: #eee !important; color: black !important; border: 1px solid black; border-left: none; }
            .summary-card { border: 1px solid black; box-shadow: none; margin-top: 10px; }
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="contenedor-auth">
        <div id="vista-login" class="card">
            <div class="text-center mb-6">
                <i class="fa-solid fa-building-columns text-4xl text-blue-600 mb-2"></i>
                <h2 class="text-2xl font-bold text-slate-800">Iniciar Sesión</h2>
                <p class="text-gray-500 text-sm">Municipio Torbes - Tesorería</p>
            </div>
            <form onsubmit="procesarLogin(event)">
                <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Correo</label>
                <input type="email" id="loginEmail" class="input-box" placeholder="funcionario@alcaldia.gob.ve" required>
                
                <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Contraseña</label>
                <input type="password" id="loginPass" class="input-box" placeholder="••••••" required>
                
                <button type="submit" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800 transition shadow-lg">
                    INGRESAR AL SISTEMA
                </button>
            </form>
            <div class="mt-6 text-center border-t border-gray-100 pt-4">
                <p class="text-sm text-gray-500 mb-2">¿Nuevo usuario?</p>
                <button type="button" onclick="irAlRegistro()" class="text-blue-600 font-bold hover:underline">
                    Crear cuenta privada
                </button>
            </div>
        </div>

        <div id="vista-registro" class="card oculto">
            <div class="text-center mb-6">
                <i class="fa-solid fa-user-shield text-4xl text-emerald-600 mb-2"></i>
                <h2 class="text-2xl font-bold text-slate-800">Registro Privado</h2>
                <p class="text-gray-500 text-sm">Sus datos serán únicos y confidenciales</p>
            </div>
            <form onsubmit="procesarRegistro(event)">
                <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Correo Institucional</label>
                <input type="email" id="regEmail" class="input-box" placeholder="ejemplo@correo.com" required>
                
                <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Crear Contraseña</label>
                <input type="password" id="regPass" class="input-box" required>
                
                <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Confirmar Contraseña</label>
                <input type="password" id="regConfirm" class="input-box" required>
                
                <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition shadow-lg">
                    REGISTRAR USUARIO
                </button>
            </form>
            <div class="mt-4 text-center">
                <button type="button" onclick="irAlLogin()" class="text-gray-500 text-sm hover:text-gray-800">
                    <i class="fa-solid fa-arrow-left"></i> Volver al Login
                </button>
            </div>
        </div>
    </div>

    <div id="vista-app" class="oculto system-wrapper">
        <div class="fixed top-0 w-full h-16 bg-white shadow-md border-b flex justify-between items-center px-6 z-50">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500 font-bold uppercase">Sesión activa</span>
                    <span id="usuario-activo" class="text-sm font-bold text-slate-800">---</span>
                </div>
            </div>
            <button onclick="cerrarSesion()" class="bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                <i class="fa-solid fa-power-off"></i> CERRAR SESIÓN
            </button>
        </div>

        <div style="height: 80px;"></div>

        <div class="container-system">
            <div class="header-top">
                <img src="logo-escudo.png" class="img-logo" alt="Escudo">
                <div class="official-header-container">
                    <div class="official-header-text" contenteditable="true" id="headerText1" oninput="autoSaveSystem()">
                        REPÚBLICA BOLIVARIANA DE VENEZUELA<br>ESTADO TÁCHIRA<br>
                        ALCALDÍA BOLIVARIANA DEL MUNICIPIO TORBES<br>DIRECCIÓN DE TESORERIA MUNICIPAL<br>RIF.: G-20005147-7
                    </div>
                    <div class="system-title-blue" contenteditable="true" id="headerText2" oninput="autoSaveSystem()">SISTEMA DE CONTROL PRESUPUESTARIO</div>
                </div>
                <img src="logo-alcaldia.png" class="img-logo" alt="Alcaldia">
            </div>

            <div class="header-controls">
                <button class="btn-action bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border-emerald-200" onclick="addRow()">
                    <i class="fa-solid fa-plus"></i> Fila
                </button>
                <button class="btn-action bg-red-50 text-red-700 hover:bg-red-100 border-red-200" onclick="removeLastRow()">
                    <i class="fa-solid fa-minus"></i> Fila
                </button>
                <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
                <button class="btn-action bg-amber-50 text-amber-700 hover:bg-amber-100 border-amber-200" onclick="addColumn()">
                    <i class="fa-solid fa-table-columns"></i> Columna
                </button>
                <button class="btn-action bg-orange-50 text-orange-700 hover:bg-orange-100 border-orange-200" onclick="removeLastColumn()">
                    <i class="fa-solid fa-eraser"></i> Columna
                </button>
                <div style="flex:1"></div>
                <button class="btn-action bg-slate-800 text-white hover:bg-slate-900" onclick="downloadBackup()">
                    <i class="fa-solid fa-floppy-disk"></i> RESPALDO
                </button>
                <button class="btn-action bg-white text-gray-600 hover:bg-gray-100 border-gray-300" onclick="resetSystem()">
                    <i class="fa-solid fa-rotate-left"></i> Limpiar Todo
                </button>
            </div>

            <div class="scroll-container">
                <div class="content-min-width">
                    <div class="info-grid">
                        <div class="header-info-block" contenteditable="true" id="headerInfoBlock" oninput="autoSaveSystem()">
                            <strong>E6928 &nbsp;&nbsp; MUNICIPIO TORBES</strong><br>
                            DISTRIBUCIÓN INSTITUCIONAL DEL PRESUPUESTO DE GASTOS<br>
                            PRESUPUESTO: DEL 01/01/2026 AL 31/12/2026
                        </div>
                        <div class="financing-title">
                            <i class="fa-solid fa-coins mr-2"></i> FUENTE DE FINANCIAMIENTO
                        </div>
                    </div>
                    <table id="dataTable" class="system-table">
                        <thead><tr id="tableHeader"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="summaries-wrapper">
                <div class="summary-card">
                    <strong><i class="fa-solid fa-chart-pie mr-1"></i> RESUMEN POR PARTIDA</strong>
                    <div id="summaryList"></div>
                </div>
                <div class="summary-card financing">
                    <strong><i class="fa-solid fa-sack-dollar mr-1"></i> RESUMEN DE FINANCIAMIENTO</strong>
                    <div id="financingSummaryList"></div>
                </div>
            </div>
            <button class="btn-print" onclick="window.print()">
                <i class="fa-solid fa-print mr-2"></i> GENERAR PDF / IMPRIMIR REPORTE OFICIAL
            </button>
            <div id="saveStatus"><i class="fa-solid fa-check"></i> Guardado seguro.</div>
        </div>
    </div>

    <script>
        // --- 1. GESTIÓN DE USUARIOS Y PRIVACIDAD ---
        
        let currentUserEmail = null; // Variable global para saber quién está conectado

        // Claves para LocalStorage
        const DB_USERS = "db_usuarios_registrados"; // { email: password }
        
        function obtenerUsuarios() {
            return JSON.parse(localStorage.getItem(DB_USERS) || "{}");
        }

        function irAlRegistro() {
            document.getElementById('vista-login').classList.add('oculto');
            document.getElementById('vista-registro').classList.remove('oculto');
        }

        function irAlLogin() {
            document.getElementById('vista-registro').classList.add('oculto');
            document.getElementById('vista-login').classList.remove('oculto');
        }

        function procesarRegistro(evento) {
            evento.preventDefault();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value;
            const confirm = document.getElementById('regConfirm').value;

            const usuarios = obtenerUsuarios();

            if(usuarios[email]) { alert("Error: Este correo ya está registrado."); return; }
            if(pass !== confirm) { alert("Error: Las contraseñas no coinciden."); return; }
            if(pass.length < 4) { alert("Error: La contraseña es muy corta."); return; }

            // Guardar nuevo usuario
            usuarios[email] = pass;
            localStorage.setItem(DB_USERS, JSON.stringify(usuarios));

            alert("¡CUENTA CREADA CON ÉXITO!\nSe ha generado un espacio de trabajo vacío para este usuario.");
            document.getElementById('regEmail').value = "";
            document.getElementById('regPass').value = "";
            document.getElementById('regConfirm').value = "";
            irAlLogin();
        }

        function procesarLogin(evento) {
            evento.preventDefault();
            const emailInput = document.getElementById('loginEmail').value.trim();
            const passInput = document.getElementById('loginPass').value;
            
            const usuarios = obtenerUsuarios();
            
            // Acceso backdoor para pruebas (opcional) o validación real
            const esAdminTest = (emailInput === 'admin@test.com' && passInput === '1234');
            const esUsuarioValido = (usuarios[emailInput] && usuarios[emailInput] === passInput);

            if (esUsuarioValido || esAdminTest) {
                entrarAlSistema(emailInput);
            } else {
                alert("ACCESO DENEGADO.\nUsuario no registrado o contraseña incorrecta.");
            }
        }

        function entrarAlSistema(email) {
            currentUserEmail = email; // Fijar usuario actual
            document.getElementById('contenedor-auth').classList.add('oculto');
            document.getElementById('vista-app').classList.remove('oculto');
            document.getElementById('usuario-activo').innerText = email;
            
            // Cargar LA DATA ESPECÍFICA de este usuario
            loadSystem();
        }

        function cerrarSesion() {
            // Recargar limpia todo
            location.reload(); 
        }

        // --- 2. SISTEMA DE TESORERÍA (CON DATOS AISLADOS) ---
        
        // Función auxiliar para obtener la key única del usuario
        function getUserDataKey() {
            if(!currentUserEmail) return 'temp_data';
            return 'tesoreria_data_' + currentUserEmail;
        }

        const dbData = [
            ["", "", "", "", "", "", "", "", "", "", "", "", "0,00", "0,00", "0,00", "0,00", "0,00", "0,00", "0,00"]
        ];

        const headers = ["SECTOR", "PROGRAMA", "SUB-P", "PROYECTO", "OBRA", "ACT", "PARTIDA", "GEN", "ESP", "S-E", "DENOMINACION", "UNIDAD EJECUTORA", "TOTAL GASTOS (Bs.)", "SITUADO MUNICIPAL.", "RECURSOS PROPIOS.", "SISTEMA PATRIA", "SITUADO ESTADAL.", "F.C.I.", "TOTAL DE RECURSOS."];

        // Lógica de Pegado desde Excel
        document.addEventListener('paste', function(e) {
            if(document.getElementById('vista-app').classList.contains('oculto')) return;

            const activeElement = document.activeElement;
            if (activeElement.tagName === 'TD' && activeElement.closest('#tableBody')) {
                e.preventDefault(); 
                const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
                const rows = clipboardData.split(/\r\n|\n|\r/).filter(row => row.trim() !== '');
                if (rows.length === 0) return;

                const startRow = activeElement.parentElement;
                const startRowIndex = Array.from(startRow.parentElement.children).indexOf(startRow);
                const startCellIndex = Array.from(startRow.children).indexOf(activeElement);
                const tableBody = document.getElementById('tableBody');
                const tableHeader = document.getElementById('tableHeader');

                const rowsNeeded = startRowIndex + rows.length;
                const currentRows = tableBody.children.length;
                if (rowsNeeded > currentRows) {
                    const rowsToAdd = rowsNeeded - currentRows;
                    for (let i = 0; i < rowsToAdd; i++) { addRow(); }
                }

                let maxColsInPaste = 0;
                rows.forEach(r => { 
                     const c = r.split('\t'); 
                     if(c.length > maxColsInPaste) maxColsInPaste = c.length;
                });

                const colsNeeded = startCellIndex + maxColsInPaste;
                const currentCols = tableHeader.children.length;

                if (colsNeeded > currentCols) {
                    const colsToAdd = colsNeeded - currentCols;
                    for (let i = 0; i < colsToAdd; i++) {
                        addColumnInternal("COL AUTO " + (currentCols + i + 1)); 
                    }
                }

                rows.forEach((rowText, rIdx) => {
                    const cols = rowText.split('\t');
                    const targetRow = tableBody.children[startRowIndex + rIdx];
                    if (targetRow) {
                        cols.forEach((cellText, cIdx) => {
                            const targetCell = targetRow.children[startCellIndex + cIdx];
                            if (targetCell) {
                                let cleanText = cellText.trim();
                                if(cleanText.startsWith('"') && cleanText.endsWith('"')) {
                                    cleanText = cleanText.substring(1, cleanText.length - 1);
                                }
                                targetCell.innerText = cleanText;
                            }
                        });
                    }
                });
                updateCalculations();
                autoSaveSystem();
            }
        });

        // Guardado automático USANDO LA KEY DEL USUARIO
        function autoSaveSystem() {
            if(!currentUserEmail) return; 

            const thElements = document.querySelectorAll("#tableHeader th");
            const currentHeaders = Array.from(thElements).map(th => th.innerText);
            const rows = document.querySelectorAll("#tableBody tr");
            const currentData = Array.from(rows).map(row => {
                return Array.from(row.cells).map(cell => cell.innerText);
            });
            const headerInfo = {
                h1: document.getElementById('headerText1').innerHTML,
                h2: document.getElementById('headerText2').innerHTML,
                h3: document.getElementById('headerInfoBlock').innerHTML
            };
            const saveData = { headers: currentHeaders, data: currentData, info: headerInfo };
            
            // Aquí está la magia de la privacidad:
            localStorage.setItem(getUserDataKey(), JSON.stringify(saveData));
            
            showSaveNotification();
        }

        // Carga del sistema USANDO LA KEY DEL USUARIO
        function loadSystem() {
            if(!currentUserEmail) return;

            const savedJSON = localStorage.getItem(getUserDataKey());
            
            if (savedJSON) {
                try {
                    const saved = JSON.parse(savedJSON);
                    if(saved.info) {
                        document.getElementById('headerText1').innerHTML = saved.info.h1;
                        document.getElementById('headerText2').innerHTML = saved.info.h2;
                        document.getElementById('headerInfoBlock').innerHTML = saved.info.h3;
                    }
                    renderHeaders(saved.headers);
                    renderRows(saved.data);
                } catch (e) {
                    loadOriginalData(); // Si falla, carga vacío
                }
            } else {
                loadOriginalData(); // Si es usuario nuevo, carga vacío
            }
            updateCalculations(false);
        }

        function loadOriginalData() {
            renderHeaders(headers);
            // Cargar siempre vacío o con una fila inicial en ceros
            renderRows(dbData);
        }

        function renderHeaders(headerList) {
            const hTr = document.getElementById('tableHeader');
            hTr.innerHTML = "";
            headerList.forEach(h => { let th = document.createElement('th'); th.innerText = h; hTr.appendChild(th); });
        }

        function renderRows(dataList) {
            const b = document.getElementById('tableBody');
            b.innerHTML = "";
            dataList.forEach(rowData => {
                let tr = document.createElement('tr');
                rowData.forEach(val => {
                    let td = document.createElement('td'); td.innerText = val; td.contentEditable = true;
                    td.oninput = function() { autoSaveSystem(); }; 
                    tr.appendChild(td);
                });
                b.appendChild(tr);
            });
        }

        function resetSystem() {
            if(confirm("ATENCIÓN: ¿Desea borrar toda la información de SU cuenta?\nEsto no afectará a otros usuarios.")) {
                localStorage.removeItem(getUserDataKey()); // Borra solo la data de este usuario
                loadOriginalData(); // Reinicia la vista
                autoSaveSystem();   // Guarda el estado vacío
            }
        }

        function downloadBackup() {
            autoSaveSystem();
            const savedJSON = localStorage.getItem(getUserDataKey());
            if(!savedJSON) { alert("No hay datos para respaldar."); return; }
            
            const blob = new Blob([savedJSON], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fecha = new Date().toLocaleDateString('es-VE').replace(/\//g, '-');
            // Nombre del archivo incluye el usuario para orden
            const userSafe = currentUserEmail.split('@')[0];
            a.download = `PRESUPUESTO_${userSafe}_${fecha}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            alert("Respaldo descargado correctamente.");
        }

        function showSaveNotification() {
            const el = document.getElementById('saveStatus');
            el.style.opacity = '1';
            setTimeout(() => { el.style.opacity = '0'; }, 2000);
        }

        function cleanValue(txt) {
            if (!txt || txt === "-" || txt.trim() === "") return 0;
            let s = txt.trim().replace(/[^\d,.-]/g, '');
            if (s.includes('.') && s.includes(',')) s = s.replace(/\./g, '').replace(',', '.');
            else if (s.includes(',')) s = s.replace(',', '.');
            return parseFloat(s) || 0;
        }

        function format(n) { return n.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function updateCalculations(shouldSave = true) {
            const headerCells = Array.from(document.querySelectorAll("#tableHeader th"));
            const rows = document.querySelectorAll("#tableBody tr");
            const findIdx = (key) => headerCells.findIndex(c => c.innerText.toUpperCase().includes(key));

            const idxPartida = findIdx("PARTIDA");
            const idxGastos = findIdx("GASTOS");

            const finMap = [
                { key: "SITUADO MUNICIPAL", total: 0, idx: findIdx("SITUADO MUNICIPAL") },
                { key: "RECURSOS PROPIOS", total: 0, idx: findIdx("RECURSOS PROPIOS") },
                { key: "SISTEMA PATRIA", total: 0, idx: findIdx("SISTEMA PATRIA") },
                { key: "SITUADO ESTADAL", total: 0, idx: findIdx("SITUADO ESTADAL") },
                { key: "F.C.I", total: 0, idx: findIdx("F.C.I") },
                { key: "TOTAL RECURSOS", total: 0, idx: findIdx("TOTAL DE RECURSOS") }
            ];

            const partSummary = {};

            rows.forEach(row => {
                if (idxPartida !== -1 && idxGastos !== -1 && row.cells[idxPartida]) {
                    let p = row.cells[idxPartida].innerText.trim();
                    let v = cleanValue(row.cells[idxGastos].innerText);
                    if (p && p !== "-") { partSummary[p] = (partSummary[p] || 0) + v; }
                }
                finMap.forEach(f => {
                    if (f.idx !== -1 && row.cells[f.idx]) f.total += cleanValue(row.cells[f.idx].innerText);
                });
            });

            let totalPartidas = 0;
            Object.values(partSummary).forEach(val => totalPartidas += val);

            let summaryHtml = Object.keys(partSummary).sort().map(p => 
                `<div class="summary-item"><span>Partida ${p}:</span><strong>${format(partSummary[p])} Bs.</strong></div>`
            ).join('') || "<span style='color:#ccc; font-style:italic;'>Sin datos registrados</span>";

            if (totalPartidas > 0) {
                summaryHtml += `<div class="summary-item" style="margin-top: 10px; border-top: 2px solid var(--sys-accent); padding-top: 8px; background: #f0f9ff;">
                    <span style="font-weight:bold; color:#0f172a;">TOTAL GENERAL:</span>
                    <strong style="font-size: 12px; color: #0f172a;">${format(totalPartidas)} Bs.</strong>
                </div>`;
            }

            document.getElementById('summaryList').innerHTML = summaryHtml;
            document.getElementById('financingSummaryList').innerHTML = finMap.map(f => 
                `<div class="summary-item"><span>${f.key}:</span><strong style="color:#10b981;">${format(f.total)} Bs.</strong></div>`
            ).join('');
            
            if(shouldSave) autoSaveSystem();
        }

        function addRow() {
            const tr = document.createElement('tr');
            const cols = document.querySelectorAll("#tableHeader th").length;
            for(let i=0; i<cols; i++) {
                let td = document.createElement('td'); td.innerText = "0,00"; td.contentEditable = true;
                td.oninput = function() { autoSaveSystem(); }; 
                tr.appendChild(td);
            }
            document.getElementById('tableBody').appendChild(tr);
            autoSaveSystem();
        }

        function removeLastRow() { if(confirm("¿Eliminar última fila?")) { document.getElementById('tableBody').deleteRow(-1); autoSaveSystem(); } }

        function addColumn() {
            let n = prompt("Nombre de la columna:");
            if(!n) return;
            addColumnInternal(n);
        }

        function addColumnInternal(name) {
            let th = document.createElement('th'); th.innerText = name.toUpperCase();
            document.getElementById('tableHeader').appendChild(th);
            document.querySelectorAll("#tableBody tr").forEach(r => {
                let td = document.createElement('td'); td.innerText = "0,00"; td.contentEditable = true;
                td.oninput = function() { autoSaveSystem(); };
                r.appendChild(td);
            });
            autoSaveSystem();
        }

        function removeLastColumn() {
            if (confirm("¿Eliminar la última columna definitivamente?")) {
                const h = document.getElementById('tableHeader');
                if (h.cells.length > 0) {
                    h.deleteCell(-1);
                    document.querySelectorAll("#tableBody tr").forEach(row => row.deleteCell(-1));
                    autoSaveSystem();
                }
            }
        }
    </script>
</body>
</html>